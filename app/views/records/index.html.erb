<% fmt       = ->v { number_with_delimiter(v, delimiter: ".", separator: ",") } %>
<% fmt_clp   = ->v { number_with_delimiter(v.to_i, delimiter: ".", separator: ",") } %>
<% show_name = ->key { @mandante_names&.[](key) || key } %>
<% meses_es  = %w[Enero Febrero Marzo Abril Mayo Junio Julio Agosto Septiembre Octubre Noviembre Diciembre] %>

<%= form_with url: records_path, method: :get, local: true, class: "mb-6 max-w-5xl mx-auto" do |f| %>
  <div class="flex flex-wrap gap-4 items-end">
    <div>
      <%= f.label :year, "Año", class: "block text-sm font-medium text-gray-700 dark:text-gray-300" %>
      <%= f.select :year, (2025..Date.current.year).to_a, { selected: @year },
                   class: "border rounded-md px-2 py-1 bg-white dark:bg-slate-800 dark:text-gray-200 shadow-sm" %>
    </div>
    <div>
      <%= f.label :month, "Mes", class: "block text-sm font-medium text-gray-700 dark:text-gray-300" %>
      <%= f.select :month,
                   options_for_select([["Año completo","all"]] + meses_es.map.with_index { |m,i| [m, i+1] },
                                      (defined?(@full_year) && @full_year) ? "all" : @month),
                   {},
                   class: "border rounded-md px-2 py-1 bg-white dark:bg-slate-800 dark:text-gray-200 shadow-sm" %>
    </div>
    <%= f.submit "Filtrar", class: "bg-blue-600 hover:bg-blue-700 text-white px-5 py-2 rounded-md" %>
  </div>
<% end %>
<% if @full_year %>
  <% max_month = @max_month || (@year.to_i == Date.current.year ? Date.current.month : 12) %>
  <% ufs_map = (@uf_map || {}).presence || (Iva.where(year: @year, month: 1..max_month).each_with_object({}) { |r,h| h[r.month] = (r.valor || r.value || r.uf || r.monto).to_d }) %>
  <% uf_clp_m = ->(uf, m) { v = (ufs_map[m] || 0).to_d; "#{number_with_delimiter(uf, delimiter: '.', separator: ',')} UF (#{number_with_delimiter((uf.to_d * v).to_i, delimiter: '.', separator: ',')} CLP)" } %>
  <% meses_es  = %w[Enero Febrero Marzo Abril Mayo Junio Julio Agosto Septiembre Octubre Noviembre Diciembre] %>
  <% show_name = ->key { @mandante_names&.[](key) || key } %>

  <% vertical_uf_by_m   = @vertical_by_month_uf   || {} %>
  <% evaluacion_uf_by_m = @evaluacion_by_month_uf || {} %>
  <% movilidad_uf_by_m  = @movilidad_by_month_uf  || {} %>

  <% vertical_ct_by_m   = @vertical_by_month_count   || {} %>
  <% evaluacion_ct_by_m = @evaluacion_by_month_count || {} %>
  <% movilidad_ct_by_m  = @movilidad_by_month_count  || {} %>

  <% month_uf  = {} %>
  <% month_cnt = {} %>
  <% (1..max_month).each do |m| %>
    <% uf_v = vertical_uf_by_m[m].to_d + evaluacion_uf_by_m[m].to_d + movilidad_uf_by_m[m].to_d %>
    <% ct_v = vertical_ct_by_m[m].to_i + evaluacion_ct_by_m[m].to_i + movilidad_ct_by_m[m].to_i %>
    <% month_uf[m]  = uf_v %>
    <% month_cnt[m] = ct_v %>
  <% end %>

  <% annual_total_uf  = month_uf.values.reduce(0.to_d, :+) %>
  <% annual_total_clp = month_uf.sum { |m,ufv| ufv.to_d * (ufs_map[m] || 0).to_d } %>
  <% annual_total_ct  = month_cnt.values.sum %>

  <% mods_full_y = {
    "Transporte Vertical"        => [(@vertical_total_uf || vertical_uf_by_m.values.sum).to_d,  vertical_uf_by_m,   @vertical_month_company || {}],
    "Evaluación de Competencias" => [(@evaluacion_total_uf || evaluacion_uf_by_m.values.sum).to_d, evaluacion_uf_by_m, @evaluation_month_company || {}],
    "Movilidad"                  => [(@movilidad_total_uf || movilidad_uf_by_m.values.sum).to_d,  movilidad_uf_by_m,  @movilidad_month_mandante || {}]
  } %>

  <% mods_full_count_y = {
    "Transporte Vertical"        => [(@vertical_total_count || vertical_ct_by_m.values.sum).to_i,  vertical_ct_by_m,   @vertical_month_company_count || {}],
    "Evaluación de Competencias" => [(@evaluacion_total_count || evaluacion_ct_by_m.values.sum).to_i, evaluacion_ct_by_m, @evaluation_month_company_count || {}],
    "Movilidad"                  => [(@movilidad_total_count || movilidad_ct_by_m.values.sum).to_i,  movilidad_ct_by_m,  @movilidad_month_mandante_count || {}]
  } %>

  <p class="text-center text-lg mb-6 text-gray-800 dark:text-white">
    <% (1..max_month).each do |m| %>
    <span class="inline-block px-2 py-1 mx-1 my-1 rounded bg-gray-100 dark:bg-slate-800">
      <%= meses_es[m-1] %>: <%= number_with_delimiter((ufs_map[m] || 0).to_i, delimiter: ".", separator: ",") %> CLP
    </span>
    <% end %>
  </p>

  <main class="max-w-7xl mx-auto space-y-10 text-gray-900 dark:text-gray-100">
    <!-- 1) RESUMEN ANUAL -->
    <section class="bg-white dark:bg-slate-900 rounded-lg shadow border border-gray-200 dark:border-slate-700 p-6">
      <h1 class="text-3xl sm:text-4xl font-semibold mb-4">
        Total Año <%= @year %>: <%= "#{number_with_delimiter(annual_total_uf, delimiter: '.', separator: ',')} UF (#{number_with_delimiter(annual_total_clp.to_i, delimiter: '.', separator: ',')} CLP)" %>
        <br>
        N° Servicios: <%= number_with_delimiter(annual_total_ct) %>
      </h1>

      <% uf_tot_v = mods_full_y["Transporte Vertical"].first %>
      <% uf_tot_e = mods_full_y["Evaluación de Competencias"].first %>
      <% uf_tot_m = mods_full_y["Movilidad"].first %>
      <% ct_tot_v = mods_full_count_y["Transporte Vertical"].first %>
      <% ct_tot_e = mods_full_count_y["Evaluación de Competencias"].first %>
      <% ct_tot_m = mods_full_count_y["Movilidad"].first %>

      <table class="w-full text-sm border-collapse">
        <thead>
        <tr>
          <th class="py-2 border border-gray-300 dark:border-slate-600">Módulo</th>
          <th class="py-2 border border-gray-300 dark:border-slate-600 text-center">Total</th>
          <th class="py-2 border border-gray-300 dark:border-slate-600 text-center">N° Servicios</th>
        </tr>
        </thead>
        <tbody>
        <tr>
          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center">Transporte Vertical</td>
          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center"><%= number_with_delimiter(uf_tot_v, delimiter: ".", separator: ",") %> UF</td>
          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center"><%= number_with_delimiter(ct_tot_v) %></td>
        </tr>
        <tr>
          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center">Evaluación de Competencias</td>
          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center"><%= number_with_delimiter(uf_tot_e, delimiter: ".", separator: ",") %> UF</td>
          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center"><%= number_with_delimiter(ct_tot_e) %></td>
        </tr>
        <tr>
          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center">
            <details>
              <summary class="cursor-pointer select-none flex items-center justify-center gap-1">
                <span class="text-xs transition-transform duration-200 details-open:rotate-90">▸</span>
                Movilidad
              </summary>
              <ul class="mt-2 mx-5 list-disc">
                <% (@movil_split_year_by_empresa || {}).each do |k,v| %>
                  <% next if v.to_d.zero? %>
                  <% c = (@movil_split_year_by_empresa_count || {})[k].to_i %>
                  <li class="flex justify-between">
                    <span><%= k %></span>
                    <span><%= number_with_delimiter(v, delimiter: ".", separator: ",") %> UF — <%= number_with_delimiter(c) %> servicios</span>
                  </li>
                <% end %>
              </ul>
            </details>
          </td>
          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center">
            <%= number_with_delimiter((@movil_split_total_uf_year || uf_tot_m), delimiter: ".", separator: ",") %> UF
          </td>
          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center"><%= number_with_delimiter(ct_tot_m) %></td>
        </tr>
        </tbody>
      </table>
    </section>

    <!-- 2) VALOR MENSUAL POR MÓDULO -->
    <section class="bg-white dark:bg-slate-900 rounded-lg shadow border border-gray-200 dark:border-slate-700 p-6">
      <h2 class="text-2xl font-semibold mb-4">Valor Mensual por Módulo</h2>
      <table class="w-full text-sm border-collapse">
        <thead>
        <tr>
          <th class="py-2 border border-gray-300 dark:border-slate-600 w-24 text-center">Mes</th>
          <th class="py-2 border border-gray-300 dark:border-slate-600 text-center">Transporte Vertical</th>
          <th class="py-2 border border-gray-300 dark:border-slate-600 text-center">Evaluación de Competencias</th>
          <th class="py-2 border border-gray-300 dark:border-slate-600 text-center">Movilidad</th>
          <th class="py-2 border border-gray-300 dark:border-slate-600 text-center">Total</th>
          <th class="py-2 border border-gray-300 dark:border-slate-600 text-center">N° Servicios</th>
        </tr>
        </thead>
        <tbody>
        <% (1..max_month).each do |m| %>
          <% v_uf  = vertical_uf_by_m[m].to_d %>
          <% e_uf  = evaluacion_uf_by_m[m].to_d %>
          <% mo_uf = movilidad_uf_by_m[m].to_d %>
          <% t_uf  = month_uf[m].to_d %>
          <% ct    = month_cnt[m].to_i %>
          <tr>
            <td class="py-2 border border-gray-300 dark:border-slate-600 text-center"><%= meses_es[m-1] %></td>
            <td class="py-2 border border-gray-300 dark:border-slate-600 text-center"><%= uf_clp_m[v_uf, m] %></td>
            <td class="py-2 border border-gray-300 dark:border-slate-600 text-center"><%= uf_clp_m[e_uf, m] %></td>
            <td class="py-2 border border-gray-300 dark:border-slate-600 text-center"><%= uf_clp_m[mo_uf, m] %></td>
            <td class="py-2 border border-gray-300 dark:border-slate-600 text-center font-medium"><%= uf_clp_m[t_uf, m] %></td>
            <td class="py-2 border border-gray-300 dark:border-slate-600 text-center font-medium"><%= number_with_delimiter(ct) %></td>
          </tr>
        <% end %>
        </tbody>
      </table>
    </section>

    <!-- 3) DETALLE POR MÓDULO -->
    <section data-controller="cube" class="bg-white dark:bg-slate-900 rounded-lg shadow border border-gray-200 dark:border-slate-700 p-6">
      <h2 class="text-2xl font-semibold mb-4">Detalle por módulo</h2>
      <ul class="space-y-2">
        <% mods_full_y.each_with_index do |(mod,(tot,monthly_map,month_comp)), idx| %>
          <% case mod
             when "Transporte Vertical"
               mod_total_count    = mods_full_count_y[mod].first.to_i
               monthly_count_map  = mods_full_count_y[mod][1] || {}
               month_comp_count   = @vertical_month_company_count || {}
             when "Evaluación de Competencias"
               mod_total_count    = mods_full_count_y[mod].first.to_i
               monthly_count_map  = mods_full_count_y[mod][1] || {}
               month_comp_count   = @evaluation_month_company_count || {}
             when "Movilidad"
               mod_total_count    = mods_full_count_y[mod].first.to_i
               monthly_count_map  = mods_full_count_y[mod][1] || {}
               month_comp_count   = @movilidad_month_mandante_count || {}
             else
               mod_total_count    = 0
               monthly_count_map  = {}
               month_comp_count   = {}
             end %>

          <li data-action="click->cube#toggle"
              class="cursor-pointer px-4 py-2 rounded-md transition-colors border
                   <%= idx.even? ? 'bg-gray-100 hover:bg-gray-200 dark:bg-slate-800 dark:hover:bg-slate-700'
                                              : 'bg-gray-50  hover:bg-gray-100 dark:bg-slate-700 dark:hover:bg-slate-600' %>">
            <span><%= mod %></span>
            <span class="float-right">
              <%= number_with_delimiter(tot, delimiter: ".", separator: ",") %> UF — <%= number_with_delimiter(mod_total_count) %> servicios
            </span>

            <ul class="hidden mt-2 space-y-1">
              <% monthly_map.keys.sort.each do |m| %>
                <% val_m = monthly_map[m].to_d %>
                <% next if val_m.zero? %>
                <li data-action="click->cube#toggle"
                    class="cursor-pointer px-3 py-1 rounded-md transition-colors border
                         <%= m.odd? ? 'bg-gray-50 hover:bg-gray-100 dark:bg-slate-700 dark:hover:bg-slate-600'
                                                          : 'bg-gray-100 hover:bg-gray-200 dark:bg-slate-800 dark:hover:bg-slate-700' %>">
                  Mes <%= meses_es[m-1] %>
                  <span class="float-right">
                    <%= uf_clp_m[val_m, m] %> — <%= number_with_delimiter(monthly_count_map[m].to_i) %> servicios
                  </span>

                  <% if mod == "Movilidad" %>
                    <% mandantes = (month_comp || {}).transform_values { |h| (h||{})[m].to_d }.reject { |_,v| v.zero? } %>
                    <% unless mandantes.empty? %>
                      <ul class="hidden mt-1 space-y-1">
                        <% mandantes.each_with_index do |(mand_rut, v_mand), i| %>
                          <% mand_name = (@mandante_names || {})[mand_rut] || mand_rut %>
                          <li data-action="click->cube#toggle"
                              class="cursor-pointer px-3 py-1 rounded-md transition-colors border
                                   <%= i.even? ? 'bg-gray-50 dark:bg-slate-700'
                                                                              : 'bg-gray-100 dark:bg-slate-800' %>">
                            <%= mand_name %>
                            <span class="float-right">
                              <%= uf_clp_m[v_mand, m] %> — <%= number_with_delimiter((month_comp_count.dig(mand_rut, m) || 0).to_i) %> servicios
                            </span>

                            <% emps = (@empresa_month_movilidad || {})
                              .select { |emp,_| (@emp_to_mandante || {})[emp]&.first == mand_rut }
                              .transform_values { |hm| (hm||{})[m].to_d }
                              .reject { |_,v| v.zero? } %>
                            <% unless emps.empty? %>
                              <ul class="hidden mt-1 space-y-1">
                                <% emps.each_with_index do |(emp, v_emp), j| %>
                                  <% cnt_emp = (@empresa_month_movilidad_count || {}).dig(emp, m).to_i %>
                                  <li class="px-3 py-1 rounded-md border
                                           <%= j.even? ? 'bg-gray-50 dark:bg-slate-700'
                                                                                              : 'bg-gray-100 dark:bg-slate-800' %>">
                                    <%= emp %>
                                    <span class="float-right">
                                      <%= uf_clp_m[v_emp, m] %> — <%= number_with_delimiter(cnt_emp) %> servicios
                                    </span>
                                  </li>
                                <% end %>
                              </ul>
                            <% end %>
                          </li>
                        <% end %>
                      </ul>
                    <% end %>
                  <% else %>
                    <% entidades = (month_comp || {}).transform_values { |h| (h||{})[m].to_d }.reject { |_,v| v.zero? } %>
                    <% unless entidades.empty? %>
                      <ul class="hidden mt-1 space-y-1">
                        <% entidades.each_with_index do |(emp, v_emp), i| %>
                          <li class="px-3 py-1 rounded-md border
                                   <%= i.even? ? 'bg-gray-50 dark:bg-slate-700'
                                                                              : 'bg-gray-100 dark:bg-slate-800' %>">
                            <%= show_name[emp] %>
                            <span class="float-right">
                              <%= uf_clp_m[v_emp, m] %> — <%= number_with_delimiter((month_comp_count.dig(emp, m) || 0).to_i) %> servicios
                            </span>
                          </li>
                        <% end %>
                      </ul>
                    <% end %>
                  <% end %>
                </li>
              <% end %>
            </ul>
          </li>
        <% end %>
      </ul>
    </section>

    <!-- 4) CLIENTES (Año completo) -->
    <section class="bg-white dark:bg-slate-900 rounded-lg shadow border border-gray-200 dark:border-slate-700 p-6">
      <h2 class="text-2xl font-semibold mb-4">Clientes (año completo)</h2>

      <% empresa_totales_uf   = @year_by_empresa || {} %>
      <% empresa_totales_cnt  = @year_by_empresa_count || {} %>

      <table class="w-full text-sm border-collapse">
        <thead>
        <tr>
          <th class="py-2 border border-gray-300 dark:border-slate-600">Cliente</th>
          <th class="py-2 border border-gray-300 dark:border-slate-600 text-center">Total</th>
          <th class="py-2 border border-gray-300 dark:border-slate-600 text-center">N° Servicios</th>
        </tr>
        </thead>
        <tbody>
        <% empresa_totales_uf.each do |cli_key, cli_val| %>
          <% is_mand = (@movilidad_year_by_empresa || {}).key?(cli_key) %>
          <tr class="<%= 'bg-gray-50 dark:bg-slate-800' if is_mand %>">
            <td class="py-2 border border-gray-300 dark:border-slate-600 align-top">
              <details>
                <summary class="cursor-pointer select-none">
                  <%= show_name[cli_key] %>
                </summary>

                <% if is_mand %>
                  <!-- Empresas pequeñas del mandante (año) -->
                  <ul class="mt-2 ml-4 list-disc">
                    <% (@empresas_por_mandante || {})[cli_key].to_a.each do |emp| %>
                      <% m_emp = (@empresa_year || {}).fetch(emp, 0).to_d %>
                      <% next if m_emp.zero? %>
                      <% c_emp = (@empresa_year_count || {}).fetch(emp, 0).to_i %>
                      <li>
                        <%= emp %>: <%= number_with_delimiter(m_emp, delimiter: ".", separator: ",") %> UF — <%= number_with_delimiter(c_emp) %> servicios
                      </li>
                    <% end %>
                  </ul>

                  <!-- Aportes por módulo (excepto Movilidad) sumando mandante + empresas -->
                  <% mods_by_val = (@module_years || {}).except("Movilidad").map do |mod, hash|
                    val = (hash[cli_key].to_d) +
                          ((@empresas_por_mandante || {})[cli_key].to_a.sum { |e| (hash[e].to_d) })
                    [mod, val]
                  end.reject { |_,v| v.zero? } %>
                  <% unless mods_by_val.empty? %>
                    <ul class="mt-2 ml-4 list-disc">
                      <% mods_by_val.each do |mod, val| %>
                        <% cnt = ((@module_years_count || {}).fetch(mod, {}).fetch(cli_key, 0).to_i) +
                                 ((@empresas_por_mandante || {})[cli_key].to_a.sum { |e| (@module_years_count || {}).fetch(mod, {}).fetch(e, 0).to_i }) %>
                        <li><%= mod %>: <%= number_with_delimiter(val, delimiter: ".", separator: ",") %> UF — <%= number_with_delimiter(cnt) %> servicios</li>
                      <% end %>
                    </ul>
                  <% end %>

                <% else %>
                  <!-- Cliente normal -->
                  <ul class="mt-2 ml-4 list-disc">
                    <% (@module_years || {}).each do |mod_name, hash| %>
                      <% v_mod = hash[cli_key].to_d %>
                      <% next if v_mod.zero? %>
                      <% cnt_mod = (@module_years_count || {}).fetch(mod_name, {}).fetch(cli_key, 0).to_i %>
                      <li>
                        <%= mod_name %>: <%= number_with_delimiter(v_mod, delimiter: ".", separator: ",") %> UF — <%= number_with_delimiter(cnt_mod) %> servicios
                      </li>
                    <% end %>
                  </ul>
                <% end %>
              </details>
            </td>
            <td class="py-2 border border-gray-300 dark:border-slate-600 text-center font-medium">
              <%= number_with_delimiter(cli_val.to_d, delimiter: ".", separator: ",") %> UF
            </td>
            <td class="py-2 border border-gray-300 dark:border-slate-600 text-center font-medium">
              <%= number_with_delimiter(empresa_totales_cnt[cli_key].to_i) %>
            </td>
          </tr>
        <% end %>
        </tbody>
      </table>
    </section>
  </main>

<% else %>


  <% uf_clp    = ->uf { "#{fmt[uf]} UF (#{fmt_clp[uf.to_d * @uf]} CLP)" } %>
  <% mods_full = {
    "Transporte Vertical"        => [@vertical_total_uf, @vertical_daily_uf, @vertical_day_company],
    "Evaluación de Competencias" => [@evaluacion_total_uf, @evaluacion_daily_uf, @evaluation_day_company],
    "Movilidad"                  => [@movilidad_total_uf,  @movilidad_daily_uf,  @movilidad_day_company]
  } %>
  <% mods_full_count = {
    "Transporte Vertical"        => [@vertical_total_count, @vertical_daily_count, @vertical_day_company_count],
    "Evaluación de Competencias" => [@evaluacion_total_count, @evaluacion_daily_count, @evaluation_day_company_count],
    "Movilidad"                  => [@movilidad_total_count,  @movilidad_daily_count,  @movilidad_day_company_count]
  } %>
  <% exact_rec = Iva.find_by(year: @year, month: @month) rescue nil %>

<p class="text-center text-lg mb-6 text-gray-800 dark:text-black">
  1 UF = <%= fmt_clp[@uf] %> CLP
  <% unless exact_rec %>(valor aproximado)<% end %>
</p>

<main class="max-w-7xl mx-auto space-y-10 text-gray-900 dark:text-gray-100">

  <section class="bg-white dark:bg-slate-900 rounded-lg shadow border border-gray-200 dark:border-slate-700 p-6">
    <h1 class="text-3xl sm:text-4xl font-semibold mb-4">
      Total <%= meses_es[@month-1] %> <%= @year %>: <%= uf_clp[@sum_month] %>
      <br>
      N° Servicios: <%= @count_month %>
    </h1>

    <table class="w-full text-sm border-collapse">
      <thead>
      <tr>
        <th class="py-2 border border-gray-300 dark:border-slate-600">Módulo</th>
        <th class="py-2 border border-gray-300 dark:border-slate-600">Total</th>
        <th class="py-2 border border-gray-300 dark:border-slate-600">N° Servicios</th>
      </tr>
      </thead>

      <tbody>
      <% mods_full.each do |mod,(tot,_,_)| %>
        <% count_tot = mods_full_count[mod].first %>
        <% if mod == "Movilidad" %>
          <tr>
            <td class="py-2 border border-gray-300 dark:border-slate-600 text-center">
              <details>
                <summary class="cursor-pointer select-none flex items-center justify-center gap-1">
                  <span class="text-xs transition-transform duration-200 details-open:rotate-90">▸</span>
                  Movilidad
                </summary>

                <ul class="mt-2 mx-5 list-disc">
                  <% @movil_split_month_by_empresa.each do |k,v| %>
                    <% next if v.zero? %>
                    <% c = @movil_split_month_by_empresa_count[k].to_i %>
                    <li class="flex justify-between">
                      <span><%= k %></span>
                      <span><%= uf_clp[v] %> — <%= number_with_delimiter(c) %> servicios</span>
                    </li>
                  <% end %>
                </ul>

              </details>
            </td>
            <td class="py-2 border border-gray-300 dark:border-slate-600 text-center">
              <%= uf_clp[@movil_split_total_uf] %>
            </td>
            <td class="py-2 border border-gray-300 dark:border-slate-600 text-center"><%= count_tot %></td>

          </tr>
        <% else %>
          <tr>
            <td class="py-2 border border-gray-300 dark:border-slate-600 text-center"><%= mod %></td>
            <td class="py-2 border border-gray-300 dark:border-slate-600 text-center">
              <%= uf_clp[tot] %>
            </td>
            <td class="py-2 border border-gray-300 dark:border-slate-600 text-center"><%= count_tot %></td>

          </tr>
        <% end %>

      <% end %>
      </tbody>
    </table>
  </section>
  <section class="bg-white dark:bg-slate-900 rounded-lg shadow border border-gray-200 dark:border-slate-700 p-6">
    <h2 class="text-2xl font-semibold mb-4">Valor Diario por Módulo</h2>

    <table class="w-full text-sm border-collapse">
      <thead>
      <tr>
        <th class="py-2 border border-gray-300 dark:border-slate-600 w-12 text-center">Día</th>
        <th class="py-2 border border-gray-300 dark:border-slate-600 text-center">Transporte Vertical</th>
        <th class="py-2 border border-gray-300 dark:border-slate-600 text-center">Evaluación de Competencias</th>
        <th class="py-2 border border-gray-300 dark:border-slate-600 text-center">Movilidad</th>
        <th class="py-2 border border-gray-300 dark:border-slate-600 text-center">Total</th>
      </tr>
      </thead>

      <tbody>
      <% (1..@days_in_month).each do |d| %>
        <% next if @sum_daily_uf[d].zero? %>
        <tr>
          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center"><%= d %></td>

          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center">
            <%= uf_clp[@vertical_daily_uf[d]] unless @vertical_daily_uf[d].zero? %>
            <br>
            <%= pluralize(@vertical_daily_count[d].to_i, 'Servicio', 'Servicios') unless @vertical_daily_count[d].to_i.zero? %>
          </td>

          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center">
            <%= uf_clp[@evaluacion_daily_uf[d]] unless @evaluacion_daily_uf[d].zero? %>
            <br>
            <%= pluralize(@evaluacion_daily_count[d].to_i, 'Servicio', 'Servicios') unless @evaluacion_daily_count[d].to_i.zero? %>
          </td>

          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center">
            <% if @movil_split_daily_uf[d].positive? %>
              <details class="inline-block">
                <summary class="cursor-pointer select-none flex items-center justify-center gap-1">
                  <span class="text-xs transition-transform duration-200 details-open:rotate-90">▸</span>
                  <%= uf_clp[@movil_split_daily_uf[d]] %>
                  <br>
                  <%= pluralize(@movilidad_daily_count[d].to_i, 'Servicio', 'Servicios') unless @movilidad_daily_count[d].to_i.zero? %>
                </summary>
                <table class="mt-1 text-xs w-full border-collapse">
                  <thead>
                  <tr>
                    <th class="text-center pr-2 py-0.5 border-t border-gray-600">Grupo</th>
                    <th class="text-center py-0.5 border-t border-gray-600">UF</th>
                    <th class="text-center py-0.5 border-t border-gray-600">Servicios</th>
                  </tr>
                  </thead>
                  <tbody>
                  <% { "Forestal Arauco SA"                     => "Forestal Arauco SA",
                       "Planta Acreditación Vehículos Forestal" => "Planta Acreditación Vehículos Forestal",
                       "Otros"                                  => "Otros" }.each do |key,label| %>
                    <% val  = (@movil_split_day_company[key] || {})[d].to_d %>
                    <% next if val.zero? %>
                    <% cnt  = (@movil_split_day_company_count[key] || {})[d].to_i %>
                    <tr>
                      <td class="pr-2 py-0.5 border-t border-gray-600 text-center"><%= label %></td>
                      <td class="py-0.5 border-t border-gray-600 text-center whitespace-nowrap"><%= uf_clp[val] %></td>
                      <td class="py-0.5 border-t border-gray-600 text-center whitespace-nowrap">
                        <%= number_with_delimiter(cnt) %>
                      </td>
                    </tr>
                  <% end %>

                  </tbody>
                </table>
              </details>
            <% end %>
          </td>

          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center font-medium">
            <%= uf_clp[@sum_daily_uf[d]] %>
            <br>
            <%= pluralize(@sum_daily_count[d].to_i, 'Servicio', 'Servicios') unless @sum_daily_count[d].to_i.zero? %>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </section>



<section data-controller="cube"
           class="bg-white dark:bg-slate-900 rounded-lg shadow border border-gray-200 dark:border-slate-700 p-6">
    <h2 class="text-2xl font-semibold mb-4">Detalle por módulo</h2>

    <ul class="space-y-2">
      <% mods_full.each_with_index do |(mod,(tot,daily,day_comp)), idx| %>
        <% case mod
           when "Transporte Vertical"
             mod_total_count    = @vertical_total_count.to_i
             daily_count_map    = @vertical_daily_count || {}
             day_comp_count_map = @vertical_day_company_count || {}
           when "Evaluación de Competencias"
             mod_total_count    = @evaluacion_total_count.to_i
             daily_count_map    = @evaluacion_daily_count || {}
             day_comp_count_map = @evaluation_day_company_count || {}
           when "Movilidad"
             mod_total_count    = @movilidad_total_count.to_i
             daily_count_map    = @movilidad_daily_count || {}
             day_comp_count_map = @movilidad_day_company_count || {}
           else
             mod_total_count    = 0
             daily_count_map    = {}
             day_comp_count_map = {}
           end %>

        <li data-action="click->cube#toggle"
            class="cursor-pointer px-4 py-2 rounded-md transition-colors border
                 <%= idx.even? ? 'bg-gray-100 hover:bg-gray-200 dark:bg-slate-800 dark:hover:bg-slate-700'
                                          : 'bg-gray-50  hover:bg-gray-100 dark:bg-slate-700 dark:hover:bg-slate-600' %>">
          <span><%= mod %></span>
          <span class="float-right">
          <%= uf_clp[tot] %> — <%= number_with_delimiter(mod_total_count) %> servicios
        </span>

          <ul class="hidden mt-2 space-y-1">
            <% daily.keys.sort.each do |d| %>
              <% next if daily[d].zero? %>
              <li data-action="click->cube#toggle"
                  class="cursor-pointer px-3 py-1 rounded-md transition-colors border
                       <%= d.odd? ? 'bg-gray-50 hover:bg-gray-100 dark:bg-slate-700 dark:hover:bg-slate-600'
                                                      : 'bg-gray-100 hover:bg-gray-200 dark:bg-slate-800 dark:hover:bg-slate-700' %>">
                Día <%= d %>
                <span class="float-right">
                <%= uf_clp[daily[d]] %> — <%= number_with_delimiter(daily_count_map[d].to_i) %> servicios
              </span>

                <% entities = day_comp.transform_values { |h| h[d] }.reject { |_,v| v.zero? } %>

                <% if mod == "Movilidad" %>
                  <% unless entities.empty? %>
                    <ul class="hidden mt-1 space-y-1">
                      <% entities.each_with_index do |(mand_rut, val), i| %>
                        <% mand_name = @mandante_names[mand_rut] || mand_rut %>
                        <li data-action="click->cube#toggle"
                            class="cursor-pointer px-3 py-1 rounded-md transition-colors border
                                 <%= i.even? ? 'bg-gray-50 dark:bg-slate-700'
                                                                          : 'bg-gray-100 dark:bg-slate-800' %>">
                          <%= mand_name %>
                          <span class="float-right">
                          <%= uf_clp[val] %> — <%= number_with_delimiter(day_comp_count_map.dig(mand_rut, d).to_i) %> servicios
                        </span>

                          <% emps = @empresa_day
                            .select { |emp,_| @emp_to_mandante[emp]&.first == mand_rut }
                            .transform_values { |h| h[d] }
                            .reject { |_,v| v.zero? } %>
                          <% unless emps.empty? %>
                            <ul class="hidden mt-1 space-y-1">
                              <% emps.each_with_index do |(emp, val_e), j| %>
                                <% c_emp = @empresa_day_count.dig(emp, d).to_i %>
                                <li class="px-3 py-1 rounded-md border
                                         <%= j.even? ? 'bg-gray-50 dark:bg-slate-700'
                                                                                          : 'bg-gray-100 dark:bg-slate-800' %>">
                                  <%= emp %>
                                  <span class="float-right">
                                  <%= uf_clp[val_e] %> — <%= number_with_delimiter(c_emp) %> servicios
                                </span>
                                </li>
                              <% end %>
                            </ul>
                          <% end %>
                        </li>
                      <% end %>
                    </ul>
                  <% end %>
                <% else %>
                  <% unless entities.empty? %>
                    <ul class="hidden mt-1 space-y-1">
                      <% entities.each_with_index do |(emp, val), i| %>
                        <li class="px-3 py-1 rounded-md border
                                 <%= i.even? ? 'bg-gray-50 dark:bg-slate-700'
                                                                          : 'bg-gray-100 dark:bg-slate-800' %>">
                          <%= show_name[emp] %>
                          <span class="float-right">
                          <%= uf_clp[val] %> — <%= number_with_delimiter(day_comp_count_map.dig(emp, d).to_i) %> servicios
                        </span>
                        </li>
                      <% end %>
                    </ul>
                  <% end %>
                <% end %>
              </li>
            <% end %>
          </ul>
        </li>
      <% end %>
    </ul>
  </section>

  <section class="bg-white dark:bg-slate-900 rounded-lg shadow border border-gray-200 dark:border-slate-700 p-6">
    <h2 class="text-2xl font-semibold mb-4">Clientes (mes completo)</h2>

    <table class="w-full text-sm border-collapse">
      <thead>
      <tr>
        <th class="py-2 border border-gray-300 dark:border-slate-600">Cliente</th>
        <th class="py-2 border border-gray-300 dark:border-slate-600 text-center">Total</th>
        <th class="py-2 border border-gray-300 dark:border-slate-600 text-center">N° Servicios</th>
      </tr>
      </thead>
      <tbody>
      <% @month_by_empresa.each do |cli_key, cli_val| %>
        <% is_mand = @movilidad_month_by_empresa.key?(cli_key) %>
        <tr class="<%= 'bg-gray-50 dark:bg-slate-800' if is_mand %>">
          <td class="py-2 border border-gray-300 dark:border-slate-600 align-top">
            <details>
              <summary class="cursor-pointer select-none">
                <%= show_name[cli_key] %>
              </summary>

              <% if is_mand %>
                <ul class="mt-2 ml-4 list-disc">
                  <% @empresas_por_mandante[cli_key].each do |emp| %>
                    <% m_emp = @empresa_month[emp] %>
                    <% next if m_emp.zero? %>
                    <% c_emp = @empresa_month_count[emp].to_i %>
                    <li>
                      <%= emp %>: <%= uf_clp[m_emp] %> — <%= number_with_delimiter(c_emp) %> servicios
                    </li>
                  <% end %>
                </ul>

                <% mods_by_val = @module_months.except("Movilidad").map do |mod, hash|
                  val = hash[cli_key].to_d +
                    @empresas_por_mandante[cli_key].sum { |e| hash[e].to_d }
                  [mod, val]
                end.reject { |_,v| v.zero? } %>

                <% unless mods_by_val.empty? %>
                  <ul class="mt-2 ml-4 list-disc">
                    <% mods_by_val.each do |mod, val| %>
                      <% cnt = (@module_months_count.fetch(mod, {}).fetch(cli_key, 0).to_i +
                        @empresas_por_mandante[cli_key].sum { |e| @module_months_count.fetch(mod, {}).fetch(e, 0).to_i }) %>
                      <li><%= mod %>: <%= uf_clp[val] %> — <%= number_with_delimiter(cnt) %> servicios</li>
                    <% end %>
                  </ul>
                <% end %>

              <% else %>
                <ul class="mt-2 ml-4 list-disc">
                  <% @module_months.each do |mod_name, hash| %>
                    <% v_mod = hash[cli_key].to_d %>
                    <% next if v_mod.zero? %>
                    <% cnt_mod = @module_months_count.fetch(mod_name, {}).fetch(cli_key, 0).to_i %>

                    <li>
                      <%= mod_name %>: <%= uf_clp[v_mod] %> — <%= number_with_delimiter(cnt_mod) %> servicios
                    </li>
                  <% end %>
                </ul>
              <% end %>
            </details>
          </td>
          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center font-medium">
            <%= uf_clp[cli_val] %>
          </td>
          <td class="py-2 border border-gray-300 dark:border-slate-600 text-center font-medium">
            <%= number_with_delimiter(@month_by_empresa_count[cli_key].to_i) %>
          </td>
        </tr>
      <% end %>
      </tbody>
    </table>
  </section>

</main>
<% end %>